---
# SPDX-FileCopyrightText: none
# SPDX-License-Identifier: CC0-1.0
name: CI

on:  # yamllint disable-line rule:truthy
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build - ${{ matrix.name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Debian 12
            container: buildpack-deps:bookworm-scm
          - name: Debian 13
            container: buildpack-deps:trixie-scm
          - name: Ubuntu 22.04
            container: buildpack-deps:22.04-scm
          - name: Ubuntu 24.04
            container: buildpack-deps:24.04-scm

    container:
      image: ${{ matrix.container }}
      env:
        DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            check \
            cython3 \
            libcurl4-openssl-dev \
            libev-dev \
            libglib2.0-dev \
            libloudmouth1-dev \
            libnetfilter-queue-dev \
            libnl-3-dev \
            libpcap-dev \
            libssl-dev \
            libtool \
            libudns-dev \
            python3 \
            python3-dev \
            python3-bson \
            python3-setuptools \
            python3-yaml \
            python3-boto3 \
            fonts-liberation

      - name: Build
        run: |
          rm -rf build/
          mkdir build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX:PATH=/opt/dionaea ..
          make

      - name: Install
        run: |
          cd build
          make install

  test:
    name: Integration Tests
    runs-on: ubuntu-latest

    container:
      image: buildpack-deps:24.04-scm
      env:
        DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            check \
            cython3 \
            libcurl4-openssl-dev \
            libev-dev \
            libglib2.0-dev \
            libloudmouth1-dev \
            libnetfilter-queue-dev \
            libnl-3-dev \
            libpcap-dev \
            libssl-dev \
            libtool \
            libudns-dev \
            python3 \
            python3-dev \
            python3-bson \
            python3-setuptools \
            python3-yaml \
            python3-boto3 \
            fonts-liberation \
            wget

      - name: Build and install
        run: |
          rm -rf build/
          mkdir build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX:PATH=/opt/dionaea ..
          make
          make install

      - name: Start dionaea daemon
        run: |
          /opt/dionaea/bin/dionaea -w /opt/dionaea -p /tmp/dionaea.pid -D &
          echo $! > /tmp/dionaea_bg.pid

      - name: Wait for dionaea to be ready
        run: |
          timeout 600 bash -c '
            while true; do
              sleep 1
              wget -O /dev/null http://localhost/ 2> /dev/null && exit 0 || true
            done
          '

      - name: Test HTTP
        run: |
          wget -O /dev/null -q --server-response http://localhost/

      - name: Test HTTPS
        run: |
          wget -O /dev/null -q --server-response --no-check-certificate https://localhost/

      - name: Show logs on failure
        if: failure()
        run: |
          tail -n 100 /opt/dionaea/var/log/dionaea/dionaea.log || true

  docs-sphinx:
    name: Documentation - Sphinx
    runs-on: ubuntu-latest
    container: buildpack-deps:bookworm-scm

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends python3 python3-sphinx python3-doc8

      - name: Build HTML documentation
        run: |
          cd doc/source
          sphinx-build -W -b html . ../_build/html

      - name: Build LaTeX documentation
        run: |
          cd doc/source
          sphinx-build -W -b latex . ../_build/latex

      - name: Check documentation style
        run: |
          doc8 --verbose --allow-long-titles --max-line-length=9999 \
            CHANGELOG.rst CONTRIBUTING.rst doc/source

  docs-doxygen:
    name: Documentation - Doxygen
    runs-on: ubuntu-latest
    container: buildpack-deps:bookworm-scm

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends doxygen

      - name: Build Doxygen documentation
        run: |
          cd doc/api
          doxygen Doxyfile

  style:
    name: Lint
    runs-on: ubuntu-latest
    container: buildpack-deps:bookworm-scm

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends git tox

      - name: Run linters
        run: |
          tox -e lint
