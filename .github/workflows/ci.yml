---
# SPDX-FileCopyrightText: none
# SPDX-License-Identifier: CC0-1.0
name: CI

on:  # yamllint disable-line rule:truthy
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build - ${{ matrix.name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Debian 12
            container: buildpack-deps:bookworm-scm
          - name: Debian 13
            container: buildpack-deps:trixie-scm
          - name: Ubuntu 22.04
            container: buildpack-deps:22.04-scm
          - name: Ubuntu 24.04
            container: buildpack-deps:24.04-scm

    container:
      image: ${{ matrix.container }}
      env:
        DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            check \
            cython3 \
            libcurl4-openssl-dev \
            libev-dev \
            libglib2.0-dev \
            libloudmouth1-dev \
            libnetfilter-queue-dev \
            libnl-3-dev \
            libpcap-dev \
            libssl-dev \
            libtool \
            libudns-dev \
            libunicorn-dev \
            python3 \
            python3-dev \
            python3-pip \
            python3-bson \
            python3-setuptools \
            python3-yaml \
            python3-boto3 \
            fonts-liberation
          # Install speakeasy-emulator (try with --break-system-packages for newer pip, fallback without)
          pip install --break-system-packages speakeasy-emulator 2>/dev/null || pip install speakeasy-emulator

      - name: Build
        run: |
          rm -rf build/
          mkdir build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX:PATH=/opt/dionaea ..
          make

      - name: Install
        run: |
          cd build
          make install

  test:
    name: Integration Tests
    runs-on: ubuntu-latest

    container:
      image: buildpack-deps:24.04-scm
      env:
        DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            check \
            cython3 \
            libcurl4-openssl-dev \
            libev-dev \
            libglib2.0-dev \
            libloudmouth1-dev \
            libnetfilter-queue-dev \
            libnl-3-dev \
            libpcap-dev \
            libssl-dev \
            libtool \
            libudns-dev \
            libunicorn-dev \
            python3 \
            python3-dev \
            python3-pip \
            python3-bson \
            python3-setuptools \
            python3-yaml \
            python3-boto3 \
            python3-construct \
            fonts-liberation \
            wget \
            curl \
            procps
          # Install speakeasy-emulator and test dependencies
          pip install --break-system-packages speakeasy-emulator 2>/dev/null || pip install speakeasy-emulator
          pip install --break-system-packages -r tests/requirements.txt 2>/dev/null || pip install -r tests/requirements.txt

      - name: Build and install
        run: |
          rm -rf build/
          mkdir build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX:PATH=/opt/dionaea ..
          make
          make install

      - name: Start dionaea daemon
        run: |
          /opt/dionaea/bin/dionaea -c /opt/dionaea/etc/dionaea/dionaea.cfg -w /opt/dionaea -p /tmp/dionaea.pid -D &
          echo $! > /tmp/dionaea_bg.pid
          sleep 5

      - name: Wait for dionaea to be ready
        run: |
          # Check if dionaea is running
          if ! pgrep -f dionaea; then
            echo "Dionaea process not found!"
            cat /opt/dionaea/var/log/dionaea/dionaea.log || true
            exit 1
          fi
          # Try to connect to HTTP service (same pattern as docker.yml)
          if ! timeout 30 bash -c "until curl -sf http://localhost/ > /dev/null 2>&1; do sleep 1; done"; then
            echo "Could not connect to dionaea HTTP service!"
            cat /opt/dionaea/var/log/dionaea/dionaea.log || true
            exit 1
          fi
          echo "Dionaea is running successfully!"

      - name: Run protocol smoke tests
        run: |
          cd tests && pytest tftp/ ftp/ smb/ http/tests/test_http_smoke.py -v --timeout=30

      - name: Show logs on failure
        if: failure()
        run: |
          tail -n 200 /opt/dionaea/var/log/dionaea/dionaea.log || true

  docs-sphinx:
    name: Documentation - Sphinx
    runs-on: ubuntu-latest
    container: buildpack-deps:bookworm-scm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends python3 python3-sphinx python3-doc8

      - name: Build HTML documentation
        run: |
          cd doc/source
          sphinx-build -W -b html . ../_build/html

      - name: Build LaTeX documentation
        run: |
          cd doc/source
          sphinx-build -W -b latex . ../_build/latex

      - name: Check documentation style
        run: |
          doc8 --verbose --allow-long-titles --max-line-length=9999 \
            CHANGELOG.rst CONTRIBUTING.rst doc/source

  docs-doxygen:
    name: Documentation - Doxygen
    runs-on: ubuntu-latest
    container: buildpack-deps:bookworm-scm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends doxygen

      - name: Build Doxygen documentation
        run: |
          cd doc/api
          doxygen Doxyfile

  style:
    name: Lint - Python
    runs-on: ubuntu-latest
    container: buildpack-deps:bookworm-scm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends git tox

      - name: Run linters
        run: |
          tox -e lint

  c-lint:
    name: Lint - C
    runs-on: ubuntu-latest
    container: buildpack-deps:bookworm-scm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential \
            clang-tidy \
            cppcheck \
            cmake \
            libcurl4-openssl-dev \
            libev-dev \
            libglib2.0-dev \
            libloudmouth1-dev \
            libnetfilter-queue-dev \
            libnl-3-dev \
            libpcap-dev \
            libssl-dev \
            libudns-dev \
            python3-dev

      - name: Generate compile_commands.json
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..

      - name: Run clang-tidy
        run: |
          # Exclude modules with optional dependencies not installed in this job
          find src modules -name '*.c' \
            -not -path 'modules/emu/*' \
            -not -path 'modules/xmatch/*' \
            -not -path 'modules/pcap/*' \
            -not -path 'modules/nl/*' \
            -not -path 'modules/nfq/*' \
            -not -path 'modules/nc/*' \
            -not -path 'modules/speakeasy/*' \
            -print0 | xargs -0 clang-tidy -p build

      - name: Run cppcheck
        run: |
          cppcheck --error-exitcode=1 --inline-suppr \
            --suppress=missingIncludeSystem \
            --enable=warning,performance,portability \
            -i modules/emu -i modules/xmatch -i modules/pcap \
            -i modules/nl -i modules/nfq -i modules/nc -i modules/speakeasy \
            src/ modules/
